{% extends "base.html" %}

{% block title %}设备远程控制{% end %}


{% block style %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@2.9.2/dist/xterm.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@2.9.2/dist/addons/fullscreen/fullscreen.min.css">
<style>
    html,
    body,
    #content-wrapper {
        height: 100%;
    }

    #content-wrapper {
        display: flex;
        flex-direction: column;
    }

    #app {
        display: flex;
        flex-grow: 1;
    }

    .height100 {
        height: 100%;
    }

    .grow-0 {
        flex-grow: 0;
    }

    .grow-1 {
        flex-grow: 1;
    }

    .nopadding {
        padding: 0px;
    }

    .color-right {
        background-color: yellowgreen;
        color: white;
    }

    .color-wrong {
        color: red;
    }

    .debugarea {
        /* background-color: #ddd; */
        border: 1px solid red;
    }

    .screen {
        position: relative;
        background-color: gray;
    }

    .canvas-fg {
        z-index: 20;
        position: absolute;
    }

    .canvas-bg {
        z-index: 10;
    }

    .xterm-wrapper {
        line-height: 1.2;
        font-size: 12px;
        font-family: 'Courier New', Courier, monospace;
        height: 30em;
    }

    .terminal {
        border: 5px solid black;
    }

    .bottom-gutter {
        margin-bottom: 10px;
    }
</style>
{% end %}

{% block nav %}
<nav class="navbar sticky-top navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <span class="title">ATXServer2</span></a>
        </a>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <div class="navbar-nav">
                <a class="nav-item nav-link active" href="/">
                    <i class="fas fa-list-alt"></i> 设备控制</a>
                <!-- <a class="nav-item nav-link active" href='/'> -->
                <!-- </a> -->
            </div>
            <div class="navbar-nav navbar-right ml-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                        {{current_user.email}}
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="/user">用户信息</a>
                        <a class="dropdown-item" href="/logout">Logout</a>
                    </div>
                </div>
                <form class="form-inline">
                    <button class="btn btn-warning" type="button" @click="stopUsing">停止使用</button>
                    <span ref="usingTime" class="navbar-text" style="margin-left: 1em">
                        使用时长
                    </span>
                </form>
            </div>
        </div>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
            aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</nav>
{% end %}

{% block content %}
<div class="container-fluid d-flex flex-column">
    <div class="row grow-1">
        <div class="col-sm debugarea d-flex flex-column justify-content-center nopadding grow-0">
            <section class="debugarea" style="height: 2rem; line-height: 2rem; justify-self: start">
                {{!properties.serial}}
                <span>
                    <i v-if="displayLinked" @click="closeMirrorDisplay" class="fas fa-link" style="color: green"></i>
                    <i v-else @click="mirrorDisplay" class="fas fa-unlink" style="color: red"></i>
                </span>
                <span>
                    <i v-if="websockets.touchpad != null" @click="closeSyncTouchpad" class="far fa-hand-paper"
                        style="color: green"></i>
                    <i v-else @click="syncTouchpad" class="far fa-hand-paper" style="color: red"></i>
                </span>
                <span>
                    <i @click="hotfix" title="hotfix" class="fas fa-hammer"></i>
                </span>

            </section>
            <section class="screen debugarea d-flex grow-1 align-items-center justify-content-center"
                style="line-height: 0px" @dblclick="runKeyevent('WAKEUP')">
                <!-- <canvas ref="fgCanvas" class="canvas-fg" v-bind:style="canvasStyle"></canvas> -->
                <canvas ref="bgCanvas" class="canvas-bg" v-bind:style="canvasStyle"></canvas>
                <span class="finger finger-0" style="transform: translate3d(200px, 100px, 0px)"></span>
                <span class="finger finger-1" style="transform: translate3d(200px, 100px, 0px)"></span>
                <!-- <img style="z-index: 10" v-if="loading" src="/assets/loading.svg"> -->
            </section>
            <section class="footer d-flex justify-content-around debugarea">
                <button class="btn btn-default grow-1" @click="runKeyevent('APP_SWITCH')">
                    <i class="fas fa-window-restore"></i>
                </button>
                <button class="btn btn-default grow-1" @click="runKeyevent('MENU')">
                    <i class="fas fa-bars"></i></button>
                <button class="btn btn-default grow-1" @click="runKeyevent('HOME')">
                    <i class="fas fa-home"></i>
                </button>
                <button class="btn btn-default grow-1" @click="runKeyevent('BACK')">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </section>
        </div>
        <div class="col-sm debugarea" style="overflow-y: auto">
            <el-tabs v-model="activeName" @tab-click="handleTabClick">
                <el-tab-pane label="常用" name="common">
                    <div ref="commonContainer" class="row">
                        <!-- 常用面板 分左右两列，宽度变小时合并为一列 -->
                        <div :class="tabColumnStyle">
                            <div class="row">
                                <div class="col-12 bottom-gutter">
                                    <div class="card">
                                        <div class="card-header">
                                            ATX
                                        </div>
                                        <div class="card-body">
                                            {{!address}}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 bottom-gutter">
                                    <div class="card bottom-gutter">
                                        <div class="card-header">
                                            <i class="fa fa-dashboard"></i>
                                            快捷入口
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-sm btn-sm btn-outline-primary"
                                                @click="runShell('am start -a android.settings.SETTINGS')">
                                                <i class="fas fa-cog"></i>
                                                Settings
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary"
                                                @click="runShell('am start -a com.android.settings.APPLICATION_DEVELOPMENT_SETTINGS')">
                                                <i class="fas fa-wrench"></i>
                                                开发者
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary"
                                                @click="runShell('am start -a android.settings.WIRELESS_SETTINGS')">
                                                <i class="fas fa-wifi"></i>
                                                WIFI
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary"
                                                @click="runShell('am start -n com.tencent.tmgp.sgame/.SGameActivity')">
                                                <i class="fas fa-gamepad"></i>
                                                王者荣耀
                                            </button>
                                            <hr>
                                            <span v-for="v in userSettings.shortcuts" style="margin-right: 5px">
                                                <el-popover trigger="hover" placement="top" min-width="160">
                                                    <code v-text="v.command"></code>
                                                    <div style="text-align: right; margin: 0">
                                                        <el-button @click="removeShortcut(v)" type="danger"
                                                            icon="el-icon-delete" size="mini" circle>
                                                        </el-button>
                                                    </div>
                                                    <el-button size="small" round slot="reference"
                                                        @click="triggerShortcut(v)">
                                                        {{!v.name}}</el-button>
                                                </el-popover>
                                            </span>
                                            <el-popover placement="right" width="400" trigger="click"
                                                v-model="userSettings.visible">
                                                <div>
                                                    <h4>增加快捷命令</h4>
                                                    <div class="form-group">
                                                        <label>名称</label>
                                                        <input class="form-control" v-model="userSettings.inputName"
                                                            type="text">
                                                    </div>
                                                    <div class="form-group">
                                                        <label>SHELL命令</label>
                                                        <input class="form-control" v-model="userSettings.inputCommand"
                                                            type="text">
                                                    </div>
                                                    <el-button size="small" @click="addShortcut">添加</i>
                                                </div>
                                                <el-button size="small" round slot="reference"><i
                                                        class="fas fa-plus"></i>
                                                </el-button>
                                            </el-popover>
                                            <!-- more https://stackoverflow.com/questions/38051706/i-am-trying-to-launch-settings-through-adb-using-the-adb-monkey-command-but-it-->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div :class="tabColumnStyle">
                            <div class="row">
                                <div class="col-12 bottom-gutter">
                                    <div class="card bottom-gutter">
                                        <div class="card-header">
                                            <i class="fa fa-globe"></i>
                                            浏览器打开URL
                                        </div>
                                        <div class="card-body">
                                            <textarea class="form-control" placeholder="在这里输入URL" rows=3
                                                v-model="browserURL" @keyup.enter="openBrowser(browserURL)"></textarea>
                                            <div style="padding-top: 5px">
                                                <button type="button" class="btn btn-primary float-right"
                                                    @click='openBrowser(browserURL)'>打开</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="Terminal" name="terminal">
                    <p><code>Ctrl+Ins</code>复制，<code>Shift+Ins</code>粘贴</p>
                    <div ref="xterm" class="xterm-wrapper"></div>
                    <div>
                        <strong>常用命令</strong>
                        <ul>
                            <li>查看IP地址
                                <term-snippet :term="term" command="ifconfig | grep Mask" />
                            </li>
                            <li>查看前台应用
                                <term-snippet :term="term"
                                    command="dumpsys activity activities | grep mFocusedActivity" />
                            </li>
                            <li>列出第三方应用
                                <term-snippet :term="term" command="pm list packages -3" />
                            </li>
                            <li>屏幕分辨率
                                <term-snippet :term="term" command="wm size" />
                            </li>
                            <li>点亮屏幕
                                <term-snippet :term="term" command="input keyevent 224"></term-snippet>
                                熄灭屏幕
                                <term-snippet :term="term" command="input keyevent 223"></term-snippet>
                            </li>
                            <li>
                                minicap
                                <term-snippet :term="term"
                                    command="LD_LIBRARY_PATH=/data/local/tmp /data/local/tmp/minicap -i"></term-snippet>
                            </li>
                            <li>更多参考 <a href="https://github.com/mzlogin/awesome-adb" target="_blank">awesome-adb</a>
                            </li>
                        </ul>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="安装管理" name="second">配置管理</el-tab-pane>
                <el-tab-pane label="截图" name="screenshot">
                    <a :href="screenshotUrl">Screenshot</a>
                </el-tab-pane>
            </el-tabs>
        </div>
    </div>


</div>
{% end %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/xterm@2.9.2/dist/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm@2.9.2/dist/addons/fit/fit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/css-element-queries@1.1.1/src/ResizeSensor.min.js"></script>
<script src="{{static_url('javascripts/imagepool.js')}}"></script>
<script>
    let udid = "{{udid}}"
    let userEmail = "{{current_user.email}}"

    function closeWindowWhenReleased() {
        setTimeout(function () {
            // FIXME(ssx): maybe websocket is better
            $.getJSON("/devices/" + udid + "?json")
                .done(function (ret) {
                    // console.log(ret.data.userId)
                    if (ret.data.userId !== userEmail) {
                        window.close()
                    }
                    closeWindowWhenReleased()
                })
                .fail(function (ret) {
                    console.log(ret)
                    alert("Fail connect to server")
                    // closeWindowWhenReleased()
                })
        }, 2000)
    }

    $.getJSON("/devices/" + udid + "?json")
        .then(ret => {

            closeWindowWhenReleased()

            vm = new Vue({
                el: "#content-wrapper",
                data: Object.assign({
                    activeName: 'common',
                    canvas: {
                        bg: null,
                        fg: null,
                    },
                    canvasStyle: {
                        opacity: 1,
                        width: '400px',
                        height: '200px',
                        maxHeight: "unset",
                    },
                    rotation: 0,
                    term: null, // Terminal object
                    websockets: {
                        screen: null,
                        touchpad: null,
                    },
                    imagePool: new ImagePool(100),
                    browserURL: "",
                    tabColumnStyle: 'col-6',
                    userSettings: Object.assign({
                        inputName: '',
                        inputCommand: '',
                        visible: false,
                        shortcuts: [{
                            command: "input keyevent POWER",
                            name: '删除',
                        }]
                    }, {}),
                }, ret.data),
                methods: {
                    loadUserSettings() {
                        return $.getJSON("/api/v1/user/settings").done(ret => {
                            this.userSettings.shortcuts = ret.shortcuts || []
                        })
                    },
                    updateUserSettings() {
                        return $.ajax({
                            method: "put",
                            url: "/api/v1/user/settings",
                            dataType: "json",
                            data: JSON.stringify({
                                "shortcuts": this.userSettings.shortcuts,
                            })
                        }).done(ret => {
                            console.log("设置已更新")
                        })
                    },
                    triggerShortcut(v) {
                        return this.runShell(v.command).done(ret => {
                            console.log("Shell", v.command, "output", ret)
                        })
                    },
                    addShortcut() {
                        let s = this.userSettings
                        if (!s.inputName || !s.inputCommand) {
                            return
                        }
                        s.shortcuts.push({
                            name: s.inputName,
                            command: s.inputCommand,
                        })
                        s.inputName = ""
                        s.inputCommand = ""
                        s.visible = false;
                        return this.updateUserSettings()
                    },
                    removeShortcut(c) {
                        this.userSettings.shortcuts = this.userSettings.shortcuts.filter(v => {
                            return v.name != c.name
                        })
                        return this.updateUserSettings()
                    },
                    hotfix() {
                        // 修复屏幕旋转问题
                        this.$notify({
                            message: "Hotfixing",
                            position: 'top-left',
                            duration: 1000,
                        })
                        $.ajax({
                            method: "get",
                            url: this.deviceUrl + "/info/rotation"
                        }).done(ret => {
                            this.$notify({
                                message: "Hotfix finished",
                                position: 'top-left',
                                duration: 1000,
                            })
                        })
                    },
                    stopUsing() {
                        $.ajax({
                            method: "delete",
                            url: "/api/v1/user/devices/" + this.udid,
                            dataType: "json"
                        }).then(ret => {
                            window.close()
                        })
                    },
                    openBrowser(url) {
                        if (!/^https?:\/\//.test(url)) {
                            url = "http://" + url;
                        }
                        this.browserURL = ""
                        return this.runShell("am start -a android.intent.action.VIEW -d " + url);
                    },
                    runShell(command) {
                        return $.ajax({
                            method: "get",
                            url: this.deviceUrl + "/shell",
                            data: {
                                "command": command,
                            },
                            dataType: "json"
                        }).done((ret) => {
                            console.log(command, ret)
                        })
                    },
                    runKeyevent(key) {
                        return this.runShell("input keyevent " + key.toUpperCase())
                    },
                    handleTabClick(tab, event) {
                        console.log(tab.name)
                        if (tab.name == "terminal") {
                            if (!this.term) {
                                this.loadTerminal()
                            }
                        }
                    },
                    loadTerminal() {
                        let term;
                        let ws = new WebSocket("ws://" + this.address + "/term");
                        ws.binaryType = "arraybuffer"

                        function ab2str(buf) {
                            return String.fromCharCode.apply(null, new Uint8Array(buf));
                        }

                        ws.onopen = (evt) => {
                            term = new Terminal({
                                screenKeys: true,
                                useStyle: true,
                                cursorBlink: true
                            })
                            term.on('data', data => {
                                ws.send(new TextEncoder().encode("\x00" + data))
                            })

                            term.on("resize", evt => {
                                ws.send(new TextEncoder().encode("\x01" + JSON.stringify({
                                    cols: evt.cols,
                                    rows: evt.rows,
                                })))
                            })

                            term.on("title", title => {
                                console.log("title", title)
                            })

                            term.open(this.$refs.xterm, { focus: true });
                            term.fit()
                            this.term = term;

                            new ResizeSensor(this.$refs.xterm, function (e) {
                                console.log("Resize", e)
                                term.resize()
                                term.fit()
                            })
                        }

                        ws.onmessage = (evt) => {
                            if (evt.data instanceof ArrayBuffer) {
                                term.write(ab2str(evt.data))
                            } else {
                                alert(evt.data)
                            }
                        }

                        ws.onclose = (evt) => {
                            term.write("Session terminated");
                            term.destroy()
                        }

                        ws.onerror = (evt) => {
                            console.log(evt)
                        }
                    },
                    mirrorDisplay() {
                        this.syncTouchpad()

                        let ws = new WebSocket(this.deviceUrl.replace(/^http/, "ws") + '/minicap');
                        this.websockets.screen = ws;

                        ws.onopen = (ev) => {
                            console.log('screen websocket connected')
                            this.canvasStyle.opacity = 1;
                        };
                        ws.onmessage = (message) => {
                            if (message.data instanceof Blob) {
                                this.drawBlobImageToCanvas(message.data, this.canvas.bg)
                            } else if (/data size: /.test(message.data)) {
                                // console.log("receive message:", message.data)
                            } else if (/^rotation/.test(message.data)) {
                                this.rotation = parseInt(message.data.substr('rotation '.length), 10);
                                console.log(this.rotation)
                            } else {
                                console.log("receive message:", message.data)
                            }
                        }
                        ws.onclose = (ev) => {
                            if (this.websockets.screen === ws) {
                                this.websockets.screen = null;
                                console.log("websocket op", this.canvasStyle.opacity)
                                this.$message({
                                    showClose: true,
                                    message: '设备屏幕同步中断',
                                    type: 'error',
                                    // duration: 0,
                                });
                                this.canvasStyle.opacity = 0.5;
                            }
                        }
                        ws.onerror = function (ev) {
                            console.log("screen websocket error")
                        }
                    },
                    closeMirrorDisplay() {
                        this.canvasStyle.opacity = 0.5;
                        if (this.websockets.screen) {
                            let ws = this.websockets.screen;
                            this.websockets.screen = null;
                            ws.close()
                        }
                        this.closeSyncTouchpad()
                    },
                    syncTouchpad() {
                        let element = this.canvas.bg; // maybe fg is better
                        let screen = {
                            bounds: {}
                        }

                        let ws = new WebSocket("ws://" + this.address + "/minitouch")
                        this.websockets.touchpad = ws

                        ws.onopen = (ret) => {
                            console.log("minitouch synced")
                        }
                        ws.onmessage = (message) => {
                            // console.log("minitouch recv", message)
                        }
                        ws.onclose = () => {
                            if (this.websockets.touchpad === ws) {
                                this.websockets.touchpad = null;
                            }
                            element.removeEventListener('mousedown', mouseDownListener);
                            element.removeEventListener('mousewheel', mouseWheelListener);
                        }

                        function calculateBounds() {
                            var el = element;
                            screen.bounds.w = el.offsetWidth
                            screen.bounds.h = el.offsetHeight
                            screen.bounds.x = 0
                            screen.bounds.y = 0

                            while (el.offsetParent) {
                                screen.bounds.x += el.offsetLeft
                                screen.bounds.y += el.offsetTop
                                el = el.offsetParent
                            }
                        }

                        /**
                         * Rotation affects the screen as follows:
                         *
                         *                   0deg
                         *                 |------|
                         *                 | MENU |
                         *                 |------|
                         *            -->  |      |  --|
                         *            |    |      |    v
                         *                 |      |
                         *                 |      |
                         *                 |------|
                         *        |----|-|          |-|----|
                         *        |    |M|          | |    |
                         *        |    |E|          | |    |
                         *  90deg |    |N|          |U|    | 270deg
                         *        |    |U|          |N|    |
                         *        |    | |          |E|    |
                         *        |    | |          |M|    |
                         *        |----|-|          |-|----|
                         *                 |------|
                         *            ^    |      |    |
                         *            |--  |      |  <--
                         *                 |      |
                         *                 |      |
                         *                 |------|
                         *                 | UNEM |
                         *                 |------|
                         *                  180deg
                         *
                         * Which leads to the following mapping:
                         *
                         * |--------------|------|---------|---------|---------|
                         * |              | 0deg |  90deg  |  180deg |  270deg |
                         * |--------------|------|---------|---------|---------|
                         * | CSS rotate() | 0deg | -90deg  | -180deg |  90deg  |
                         * | bounding w   |  w   |    h    |    w    |    h    |
                         * | bounding h   |  h   |    w    |    h    |    w    |
                         * | pos x        |  x   |   h-y   |   w-x   |    y    |
                         * | pos y        |  y   |    x    |   h-y   |   h-x   |
                         * |--------------|------|---------|---------|---------|
                         */
                        function coords(boundingW, boundingH, relX, relY, rotation) {
                            var w, h, x, y;

                            switch (rotation) {
                                case 0:
                                    w = boundingW
                                    h = boundingH
                                    x = relX
                                    y = relY
                                    break
                                case 90:
                                    w = boundingH
                                    h = boundingW
                                    x = boundingH - relY
                                    y = relX
                                    break
                                case 180:
                                    w = boundingW
                                    h = boundingH
                                    x = boundingW - relX
                                    y = boundingH - relY
                                    break
                                case 270:
                                    w = boundingH
                                    h = boundingW
                                    x = relY
                                    y = boundingW - relX
                                    break
                            }

                            return {
                                xP: x / w,
                                yP: y / h,
                            }
                        }

                        let touchDown = (index, x, y, pressure) => {
                            let scaled = coords(screen.bounds.w, screen.bounds.h, x, y, this.rotation);
                            ws.send(JSON.stringify({
                                operation: 'd',
                                index: index,
                                pressure: pressure,
                                xP: scaled.xP,
                                yP: scaled.yP,
                            }))
                        }

                        let touchMove = (index, x, y, pressure) => {
                            let scaled = coords(screen.bounds.w, screen.bounds.h, x, y, this.rotation);
                            ws.send(JSON.stringify({
                                operation: 'm',
                                index: index,
                                pressure: pressure,
                                xP: scaled.xP,
                                yP: scaled.yP,
                            }))
                        }

                        function touchWait(millseconds) {
                            ws.send(JSON.stringify({
                                operation: 'w',
                                milliseconds: millseconds,
                            }))
                        }

                        function touchUp(index) {
                            ws.send(JSON.stringify({
                                operation: 'u',
                                index: index,
                            }))
                        }

                        function touchCommit() {
                            ws.send(JSON.stringify({ operation: 'c' }))
                        }

                        let mouseDownListener = (event) => {
                            var e = event;
                            if (e.originalEvent) {
                                e = e.originalEvent
                            }
                            e.preventDefault()

                            // Middle click equals HOME
                            if (e.which === 2) {
                                this.runKeyevent("HOME")
                                return
                            }
                            // Right click equals BACK
                            if (e.which === 3) {
                                this.runKeyevent("BACK")
                                return
                            }


                            fakePinch = e.altKey
                            calculateBounds()

                            var x = e.pageX - screen.bounds.x
                            var y = e.pageY - screen.bounds.y
                            var pressure = 0.5
                            // activeFinger(0, e.pageX, e.pageY, pressure);

                            touchDown(0, x, y, pressure);
                            touchCommit();

                            // element.removeEventListener('mousemove', mouseHoverListener);
                            element.addEventListener('mousemove', mouseMoveListener);
                            document.addEventListener('mouseup', mouseUpListener);
                        }

                        let mouseMoveListener = (event) => {
                            var e = event
                            if (e.originalEvent) {
                                e = e.originalEvent
                            }
                            // Skip secondary click
                            if (e.which === 3) {
                                return
                            }
                            e.preventDefault()

                            var pressure = 0.5
                            activeFinger(0, e.pageX, e.pageY, pressure);
                            var x = e.pageX - screen.bounds.x
                            var y = e.pageY - screen.bounds.y

                            touchMove(0, x, y, pressure);
                            touchCommit();
                        }

                        function mouseUpListener(event) {
                            var e = event
                            if (e.originalEvent) {
                                e = e.originalEvent
                            }
                            // Skip secondary click
                            if (e.which === 3) {
                                return
                            }
                            e.preventDefault()

                            touchUp(0)
                            touchCommit()
                            stopMousing()
                        }

                        function stopMousing() {
                            element.removeEventListener('mousemove', mouseMoveListener);
                            // element.addEventListener('mousemove', mouseHoverListener);
                            document.removeEventListener('mouseup', mouseUpListener);
                            deactiveFinger(0);
                        }

                        function activeFinger(index, x, y, pressure) {
                            var scale = 0.5 + pressure
                            $(".finger-" + index)
                                .addClass("active")
                                .css("transform", 'translate3d(' + x + 'px,' + y + 'px,0)')
                        }

                        function deactiveFinger(index) {
                            $(".finger-" + index).removeClass("active")
                        }

                        function preventHandler(event) {
                            event.preventDefault()
                        }

                        let wheel = {
                            count: 0,
                            key: null,
                            mouseY: null,
                        };

                        function mouseWheelListener(event) {
                            let e = event
                            if (e.originalEvent) {
                                e = e.originalEvent
                            }

                            calculateBounds()
                            let x = e.pageX - screen.bounds.x
                            let y = e.pageY - screen.bounds.y
                            let pressure = 0.5

                            if (wheel.key === null) { // mouse down
                                wheel.mouseY = y;
                                touchDown(1, x, y, pressure)
                                touchCommit()
                            } else {
                                clearTimeout(wheel.key)
                            }

                            // 从 wheel.mouseY --> targetY 分10步移动完
                            wheel.count += 1
                            const stepCount = 10; // 10 steps
                            const direction = e.deltaY > 0 ? -1 : 1
                            const offsetY = wheel.count * direction * 0.2 * screen.bounds.h
                            const targetY = Math.max(0, Math.min(y + offsetY, screen.bounds.h))

                            let mouseY = wheel.mouseY;
                            const stepY = (targetY - mouseY) / stepCount;
                            for (let i = 0; i < stepCount; i += 1) {
                                mouseY += stepY;
                                touchWait(10); // 间隔10ms
                                touchMove(1, x, mouseY, pressure)
                                touchCommit()
                            }
                            wheel.mouseY = targetY; // 记录当前点的位置

                            wheel.key = setTimeout(() => { // wheel stopped do mouse up
                                touchUp()
                                touchCommit()
                                wheel.key = null;
                                wheel.count = 0;
                            }, 100)
                        }

                        /* bind listeners */
                        element.addEventListener('mousedown', mouseDownListener);
                        element.addEventListener('mousewheel', mouseWheelListener);
                        // element.addEventListener('mousemove', mouseHoverListener);
                    },
                    closeSyncTouchpad() {
                        if (this.websockets.touchpad) {
                            this.websockets.touchpad.close()
                        }
                    },
                    fitCanvas(canvas) {
                        if (canvas.width > canvas.height) {
                            // 横屏显示，宽高相等
                            this.canvasStyle.maxHeight = canvas.parentElement.clientHeight + "px";
                            this.canvasStyle.height = "auto"
                            this.canvasStyle.width = canvas.parentElement.clientHeight + "px"
                        } else {
                            this.canvasStyle.maxHeight = "unset"
                            this.canvasStyle.height = canvas.parentElement.clientHeight + "px"
                            this.canvasStyle.width = "auto"
                        }
                    },
                    drawBlobImageToCanvas(blob, canvas) {
                        // Support jQuery Promise
                        var dtd = $.Deferred();
                        var ctx = canvas.getContext('2d'),
                            URL = window.URL || window.webkitURL,
                            BLANK_IMG =
                                'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==',
                            img = this.imagePool.next();

                        img.onload = () => {
                            canvas.width = img.width
                            canvas.height = img.height

                            ctx.drawImage(img, 0, 0, img.width, img.height);
                            this.fitCanvas(canvas)

                            // Try to forcefully clean everything to get rid of memory
                            // leaks. Note self despite this effort, Chrome will still
                            // leak huge amounts of memory when the developer tools are
                            // open, probably to save the resources for inspection. When
                            // the developer tools are closed no memory is leaked.
                            img.onload = img.onerror = null
                            img.src = BLANK_IMG
                            img = null
                            blob = null

                            URL.revokeObjectURL(url)
                            url = null
                            dtd.resolve();
                        }

                        img.onerror = function () {
                            // Happily ignore. I suppose this shouldn't happen, but
                            // sometimes it does, presumably when we're loading images
                            // too quickly.

                            // Do the same cleanup here as in onload.
                            img.onload = img.onerror = null
                            img.src = BLANK_IMG
                            img = null
                            blob = null

                            URL.revokeObjectURL(url)
                            url = null
                            dtd.reject();
                        }
                        var url = URL.createObjectURL(blob)
                        img.src = url;
                        return dtd;
                    },
                },
                mounted: function () {
                    this.canvas.bg = this.$refs.bgCanvas
                    this.canvas.fg = this.$refs.fgCanvas
                    let ctx = this.canvas.bg.getContext('2d');
                    this.mirrorDisplay()
                    this.syncTouchpad()

                    new ResizeSensor(this.canvas.bg.parentElement, (e) => {
                        this.fitCanvas(this.canvas.bg)
                    })

                    // 常用功能面板 自适应
                    new ResizeSensor(this.$refs.commonContainer, (e) => {
                        if (e.width < 600) {
                            this.tabColumnStyle = "col-12"
                        } else {
                            this.tabColumnStyle = "col-6"
                        }
                    })

                    this.canvas.bg.addEventListener('contextmenu', event => event.preventDefault());

                    // save the bandwidth
                    document.addEventListener("visibilitychange", () => {
                        let pageHidden = document.hidden;
                        if (pageHidden) {
                            this.closeMirrorDisplay()
                            this.closeSyncTouchpad()
                        } else {
                            this.mirrorDisplay()
                            this.syncTouchpad()
                        }
                    })

                    // 更新使用时间
                    setInterval(() => {
                        let duration = moment.now() - moment(this.usingBeganAt)
                        this.$refs.usingTime.innerHTML = moment.utc(duration).format("HH:mm:ss")
                    }, 1000)

                    // 唤醒屏幕
                    this.runKeyevent("WAKEUP")

                    // 加载用户配置
                    this.loadUserSettings()
                },
                computed: {
                    deviceUrl() {
                        return "http://" + this.address
                    },
                    remoteTerminal() {
                        return "http://" + this.address + "/term"
                    },
                    screenshotUrl() {
                        return "http://" + this.address + "/screenshot"
                    },
                    displayLinked() {
                        return this.websockets.screen !== null;
                    }
                },
                components: {
                    "term-snippet": {
                        props: {
                            command: String,
                            term: Object,
                        },
                        methods: {
                            run() {
                                this.term.emit("data", this.command + "\n");
                                this.term.focus()
                            }
                        },
                        template: '<code style="cursor: pointer" @click="run" v-text="command"></code>'
                    }
                }
            })
        })
</script>
{% end %}